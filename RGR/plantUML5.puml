@startuml BackgroundTasksSequence

!theme plain
skinparam sequenceMessageAlign center
skinparam BoxPadding 10
skinparam ParticipantPadding 15

title Sequence Diagram: Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ñ ProgressDialog (10 Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²)

actor "ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ" as user
participant "ğŸ–¥ï¸ PowerSystemDemo" as main <<Main Window>>
participant "â³ ProgressDialog" as dialog <<Modal>>
participant "ğŸ“¦ ExportDataTask" as task <<SwingWorker>>
participant "ğŸ§µ Worker Thread" as worker <<Background>>
participant "ğŸ¨ EDT Thread" as edt <<Swing>>

autonumber

== ğŸš€ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ñ†Ğ¸Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ° ==
user -> main: ĞœĞµĞ½Ñ â†’ Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
activate main #LightBlue
main -> task: new ExportDataTask(controllers, file)
activate task #LightYellow
task -> task: startTime = now()
return
deactivate task

main -> dialog: new ProgressDialog(this, "Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚")
activate dialog #LightCoral
dialog -> dialog: init: JProgressBar + Timer
main -> dialog: executeTask(task)

dialog -> task: setProgressListener(Î»)
dialog -> task: setCompletionListener(Î»)

== ğŸƒ Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ° ==
dialog -> task: execute()
activate task #LightYellow
task -> worker: doInBackground()
activate worker #LightGreen
note right of worker #AAFFAA
  âš™ï¸ **SwingWorker Thread**
  ĞĞ• Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ GUI!
end note

dialog -> user: setVisible(true) ğŸ”’
note right of dialog #FFAAAA
  âš ï¸ **Modal Window**
  Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾
end note

== ğŸ“ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€ĞµÑÑĞ¾Ğ¼ ==
worker -> task: performTask()
activate task #LightYellow

task -> task: publishProgress(0, "ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ°...")
task -> edt: publish(ProgressUpdate)
activate edt #LightSkyBlue
edt -> dialog: onProgressUpdate(0, "...")
dialog -> dialog: progressBar.setValue(0)
return
deactivate edt

loop ğŸ“Š Ğ”Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° (1..N)
    task -> task: checkCancelled()
    alt âŒ ĞÑ‚Ğ¼ĞµĞ½Ğ° Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ°
        task -> task: throw TaskCancelledException
        note right of task #FFCCCC
          ğŸ›‘ ĞŸÑ€ĞµÑ€Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ
        end note
    end
    
    task -> task: writer.write(device.toCsv())
    task -> task: publishProgress(percent, "Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ¾ i/N")
    task -> edt: publish(ProgressUpdate)
    activate edt #LightSkyBlue
    edt -> dialog: onProgressUpdate(percent, msg)
    dialog -> dialog: progressBar.setValue()
    return
    deactivate edt
    
    task -> task: Thread.sleep(100)
end

task -> task: publishProgress(100, "Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾!")
return File
deactivate task

== âœ… Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ğµ Ğ² EDT ==
worker -> task: done()
task -> edt: completionListener.onSuccess(file)
activate edt #LightSkyBlue
edt -> dialog: onSuccess(file)
dialog -> dialog: dispose()
dialog -> user: ğŸ“„ JOptionPane: "Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½!"
note right of user #AAFFAA
  âœ… **Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**
  Ğ¤Ğ°Ğ¹Ğ»: system_export.csv
  Ğ£ÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²: 3
  Ğ—Ğ°Ğ¿Ğ¸ÑĞµĞ¹: 30
  Ğ’Ñ€ĞµĞ¼Ñ: 5.6 ÑĞµĞº
end note
deactivate edt
deactivate worker
deactivate task
deactivate dialog
deactivate main

== âš ï¸ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°: ĞÑˆĞ¸Ğ±ĞºĞ° ==
alt ğŸ”¥ IOException Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸
    worker -> task: throw IOException
    activate task #FFCCCC
    task -> edt: completionListener.onError(ex)
    activate edt #FFCCCC
    edt -> dialog: onError(ex)
    dialog -> user: âŒ JOptionPane: "ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°!"
    note right of user #FFCCCC
      âŒ **ĞÑˆĞ¸Ğ±ĞºĞ°:**
      Access denied to file
    end note
    deactivate edt
    deactivate task
end

== âš ï¸ ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°: ĞÑ‚Ğ¼ĞµĞ½Ğ° ==
alt ğŸ›‘ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ½Ğ°Ğ¶Ğ°Ğ» "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"
    user -> dialog: ĞšĞ»Ğ¸Ğº "ĞÑ‚Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ"
    activate dialog #LightCoral
    dialog -> task: requestCancel()
    activate task #LightYellow
    task -> task: cancelled = true
    task -> worker: Thread.interrupt()
    activate worker #FFCCCC
    worker -> task: checkCancelled()
    task -> task: throw TaskCancelledException
    task -> edt: completionListener.onCancelled()
    activate edt #LightGray
    edt -> dialog: onCancelled()
    dialog -> dialog: dispose()
    note right of dialog #CCCCCC
      ğŸ›‘ **ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ°**
      Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¾Ñ‚Ğ±Ñ€Ğ¾ÑˆĞµĞ½
    end note
    deactivate edt
    deactivate worker
    deactivate task
    deactivate dialog
end

footer "Ğ Ğ“Ğ  Ğ§Ğ°ÑÑ‚ÑŒ 5 Ğ¸Ğ· 5 Sequence Diagram: Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸"

@enduml